# Игровой движок

Этот раздел описывает архитектуру игрового движка, его компоненты и взаимодействие между ними.

## Классы

### 1. Bot

Класс `Bot` представляет бота, участвующего в игре, который выбирает карты на основе уровня сложности и состояния игрового поля.

---

### Поля (переменные) класса `Bot`

- **`interval`**: `NodeJS.Timeout | undefined`  
  Таймер для управления задержками в действиях бота, таких как открытие карт.
- **`score`**: `number`  
  Количество очков бота, увеличивается при нахождении совпадающих карт.
- **`id`**: `number`  
  Уникальный идентификатор бота.
- **`difficulty`**: `Difficulty`  
  Уровень сложности, определяющий вероятность успешного выбора пары карт.
- **`gameBoard`**: `GameBoard`  
  Игровое поле, с которым взаимодействует бот, выбирая и проверяя карты.
- **`round`**: `Round`  
  Текущий раунд игры, в котором бот делает ходы и отслеживает состояние.
- **`liquidDifficulty`**: `Difficulty | 0 | number`  
  Переменная для динамического изменения сложности бота в зависимости от количества оставшихся неподобранных карт.
- **`name`**: `string`  
  Имя бота, по умолчанию установлено как `'Бот'`.

---

### Методы класса `Bot`

- **`constructor(id: number, difficulty: Difficulty, gameBoard: GameBoard, round: Round)`**  
  Конструктор, инициализирует бота с уникальным идентификатором, уровнем сложности, игровым полем и раундом.
- **`getName(): string`**  
  Возвращает имя бота.
- **`getId(): number`**  
  Возвращает уникальный идентификатор бота.
- **`addPoint(): void`**  
  Увеличивает счет бота на 1 и отправляет событие `bot-score-update` через `GameEventBus`.
- **`showCards(card1: Card, card2: Card): void`**  
  Открывает заданные карты с задержкой и отображает их на игровом поле. Этот метод использует таймер для плавного открытия двух карт поочередно и запускает проверку на совпадение.
- **`findMatchingPair(cards: Card[], probability: number): [Card, Card] | null`**  
  Находит пару совпадающих карт на игровом поле на основе заданной вероятности. Если вероятность позволяет, возвращает пару карт; иначе - `null`.
- **`increaseDifficultyByUnmatchedCards(unmatchedCardsCount: number, calculatedDifficulty: number): number`**  
  Увеличивает сложность, если количество оставшихся неподобранных карт становится низким. Используется для повышения вероятности нахождения пары по мере уменьшения карт на поле.
- **`calculateProbability(): { cards: Card[], probability: number }`**  
  Рассчитывает вероятность нахождения пары карт на основе уровня сложности и состояния поля. Возвращает объект с отфильтрованными картами и рассчитанной вероятностью.
- **`chooseRandomUniqueCards(cards: Card[]): [Card, Card] | null`**  
  Выбирает две случайные уникальные карты из доступных, если нет совпадающей пары. Возвращает пару уникальных карт или `null`, если выбрать пару невозможно.
- **`chooseCards(): void`**  
  Основной метод выбора карт ботом. Сначала пробует найти совпадающую пару карт с учетом вероятности, если не удается, выбирает две случайные карты. Выбранные карты открываются методом `showCards`.

### 2. Card

Класс `Card` представляет карточку на игровом поле и содержит логику для работы с состояниями, такими как открытие, совпадение, анимация переворота и отображение.

---

### Поля (переменные) класса `Card`

- **`id`**: `number`  
  Уникальный идентификатор карточки для определения совпадения.
- **`image`**: `HTMLImageElement`  
  Изображение, отображаемое на лицевой стороне карточки.
- **`isRevealed`**: `boolean`  
  Флаг, показывающий, открыта ли карточка.
- **`isMatched`**: `boolean`  
  Флаг, указывающий, подобрана ли карточка в пару.
- **`isHovered`**: `boolean`  
  Флаг, указывающий на то, что карточка в данный момент подсвечивается при наведении.
- **`flipProgress`**: `number`  
  Прогресс анимации переворота карточки (от 0 до 1).
- **`isFlipping`**: `boolean`  
  Флаг, указывающий, происходит ли в данный момент анимация переворота карточки.
- **`isTouched`**: `boolean`  
  Флаг, указывающий, была ли карточка открыта в текущем раунде.

---

### Методы класса `Card`

- **`constructor(id: number, image: HTMLImageElement)`**  
  Конструктор, инициализирующий карточку с уникальным идентификатором и изображением.
- **`checkRevealed(): boolean`**  
  Возвращает `true`, если карточка открыта, иначе — `false`.
- **`checkMatched(): boolean`**  
  Возвращает `true`, если карточка уже была подобрана в пару.
- **`checkTouched(): boolean`**  
  Возвращает `true`, если карточка была открыта в текущем раунде.
- **`reveal(): void`**  
  Открывает карточку, активируя анимацию переворота, и помечает её как выбранную.
- **`hide(): void`**  
  Скрывает карточку, если она не подобрана в пару, и запускает анимацию переворота для закрытия.
- **`checkMatch(otherCard: Card): boolean`**  
  Проверяет, совпадает ли текущая карточка с другой переданной карточкой. Если совпадает, устанавливает флаг `isMatched` и возвращает `true`, иначе — `false`.
- **`getId(): number`**  
  Возвращает уникальный идентификатор карточки.
- **`animateFlip(): void`**  
  Выполняет анимацию переворота карточки. Управляет состоянием анимации, увеличивая `flipProgress` и отправляя события рендера на каждом шаге.
- **`highlight(): void`**  
  Включает подсветку карточки при наведении, если она не была открыта.
- **`clearHighlight(): void`**  
  Отключает подсветку карточки.
- **`draw(ctx: CanvasRenderingContext2D, x: number, y: number, width: number, height: number): void`**  
  Отрисовывает карточку на переданном контексте. Принимает координаты и размеры для позиционирования и отображает либо изображение, либо цветовую сторону в зависимости от состояния `isRevealed`. Также применяет масштабирование для анимации переворота и меняет цвет при наведении.

### 3. GameBoard

Класс `GameBoard` отвечает за логику игрового поля, включая управление карточками, их размещение на сетке, анимацию, события выбора, проверки совпадений и отрисовку на холсте.

---

### Поля (переменные) класса `GameBoard`

- **`cards`**: `Card[]`  
  Список всех карточек на игровом поле.
- **`ctx`**: `CanvasRenderingContext2D`  
  Контекст 2D-отрисовки для холста, на котором отображается игровое поле.
- **`selectedCards`**: `Card[]`  
  Массив текущих выбранных карточек.
- **`grid`**: `Card[][]`  
  Сетка карточек, упорядоченная в соответствии с количеством строк и столбцов.
- **`rows`**: `number`  
  Количество строк на игровом поле.
- **`columns`**: `number`  
  Количество столбцов на игровом поле.
- **`cardWidth`**: `number`  
  Ширина каждой карточки на игровом поле.
- **`cardHeight`**: `number`  
  Высота каждой карточки на игровом поле.
- **`padding`**: `number`  
  Промежуток между карточками.
- **`canvas`**: `HTMLCanvasElement`  
  Элемент холста, на котором отображается игровое поле.

---

### Методы класса `GameBoard`

- **`constructor(canvas: HTMLCanvasElement, { rows = 4, columns = 4, padding = 4 }: Options)`**  
  Создает игровое поле, инициализируя сетку карточек и размеры, и настраивает обработку событий рендера.
- **`createCardPairs(): Promise<Card[]>`**  
  Асинхронно загружает изображения и создает пары карточек для размещения на игровом поле.
- **`setupBoard(): Promise<void>`**  
  Инициализирует игровое поле, загружая пары карточек, перемешивая их и формируя сетку, а затем отрисовывает поле.
- **`getCards(): Card[]`**  
  Возвращает все карточки на игровом поле.
- **`getSelectedCards(): Card[]`**  
  Возвращает текущие выбранные карточки.
- **`checkAllCardsMatched(): boolean`**  
  Проверяет, подобраны ли все карточки на игровом поле в пары.
- **`checkSelectedCardsMatched(): boolean`**  
  Проверяет, совпадает ли текущая пара выбранных карточек.
- **`addSelectedCard(card: Card): void`**  
  Добавляет карточку в массив выбранных карточек.
- **`deleteSelectedCards(): void`**  
  Очищает массив выбранных карточек.
- **`clean(): void`**  
  Скрывает все неподобранные карточки, сбрасывает подсветку и очищает выбранные карточки, затем перерисовывает поле.
- **`loadImages(): Promise<HTMLImageElement[]>`**  
  Загружает изображения карточек (в будущем ожидается получение изображений с сервера).
- **`isMaxCardsSelected(): boolean`**  
  Проверяет, выбраны ли уже две карточки для текущего хода.
- **`shuffle(cards: Card[]): Card[]`**  
  Перемешивает массив карточек.
- **`createGrid(cards: Card[]): Card[][]`**  
  Создает сетку из карточек, распределяя их по строкам и столбцам в соответствии с заданными параметрами.
- **`getCardAtPosition(position: { x: number; y: number }): Card | null`**  
  Определяет, какая карточка находится в указанных координатах, и возвращает её или `null`, если карточка не найдена.
- **`highlightCard(card: Card): void`**  
  Включает подсветку для заданной карточки.
- **`clearHighlight(): void`**  
  Отключает подсветку для всех карточек на игровом поле.
- **`getEventPosition(event: MouseEvent | TouchEvent): { x: number; y: number }`**  
  Вычисляет позицию клика или касания относительно холста, преобразуя координаты события.
- **`render(): void`**  
  Очищает холст и отрисовывает каждую карточку в сетке с учетом их текущего состояния (открыта, подсвечена или скрыта).

### 4. Player

Класс `Player` представляет игрока в карточной игре. Он управляет логикой, связанной с именем игрока, его счетом и взаимодействием с игровым полем и раундами игры.

---

## Поля (переменные) класса

- **`score`**: `number`  
  Счет игрока.
- **`id`**: `number`  
  Уникальный идентификатор игрока.
- **`gameBoard`**: `GameBoard`  
  Ссылка на игровое поле, с которым игрок взаимодействует.
- **`round`**: `Round`  
  Ссылка на объект текущего раунда игры.
- **`name`**: `string`  
  Имя игрока (по умолчанию 'Игрок').

---

## Методы класса

### `constructor(id: number, gameBoard: GameBoard, round: Round)`

Конструктор инициализирует игрока с уникальным `id`, ссылкой на игровое поле и текущий раунд.

### `getName(): string`

Возвращает имя игрока.

### `getId(): number`

Возвращает уникальный идентификатор игрока.

### `addPoint(): void`

Увеличивает счет игрока на 1 и эмиттирует событие `score-update` через шину событий.

### `getScore(): number`

Возвращает текущий счет игрока.

### `chooseCards(position: { x: number; y: number }): void`

Метод для выбора карты игроком:

### 5. Round

Класс `Round` отвечает за логику текущего раунда игры, управление игроками (в том числе ботами), переключение ходов, управление таймером и проверку совпадений карт. Также он управляет состоянием игрового поля и отслеживает прогресс игры.

---

## Поля (переменные) класса

- **`gameBoard`**: `GameBoard`  
  Ссылка на объект игрового поля.
- **`currentRound`**: `number`  
  Номер текущего раунда.
- **`timer`**: `Timer`  
  Таймер, отсчитывающий время для раунда.
- **`currentPlayer`**: `Player | Bot`  
  Игрок или бот, чей ход наступает в данный момент.
- **`players`**: `(Player | Bot)[]`  
  Массив всех игроков (включая бота, если используется режим с ботом).
- **`mode`**: `GameModes`  
  Режим игры (игрок против игрока или игрок против бота).

---

## Методы класса

### `constructor(gameBoard: GameBoard, difficulty: Difficulty, mode: GameModes)`

Конструктор инициализирует раунд, устанавливает игровое поле, игроков и таймер, в зависимости от выбранного режима игры (с ботом или без).

### `start()`

Запускает таймер, инициализирует игровое поле и отрисовывает его.

### `reset()`

Сбрасывает состояние раунда, останавливает таймер и сбрасывает номер текущего раунда.

### `next()`

Переходит к следующему раунду, перезапуская игру.

### `switchTurn()`

Переключает ход между игроками, проверяет совпадение карт и завершает раунд, если все карты подобраны в пары.

### `stopRound()`

Завершает текущий раунд, останавливает таймер и переключает ход.

### `resetTime()`

Сбрасывает таймер на начальное значение.

### `checkForMatch()`

Проверяет, совпадают ли две выбранные карты. Если совпадают, добавляется очко текущему игроку, а карты удаляются. Если не совпадают, переключается ход.

### `complete()`

Завершает текущий раунд, инициализирует следующий и сбрасывает таймер.

### `handleInput(event: MouseEvent | TouchEvent)`

Обрабатывает ввод игрока (клик или касание) и вызывает метод выбора карт. Если все карты подобраны, раунд завершается.

### `handleHover(event: MouseEvent)`

Обрабатывает наведение мыши на карту, выделяя её для предварительного просмотра.

### 6. Timer

Класс `Timer` управляет временем раунда, отсчитывая время для каждого хода и взаимодействуя с другими компонентами игры через шину событий. Он отслеживает оставшееся время, запускает, сбрасывает и останавливает таймер, а также управляет переключением ходов по истечении времени.

---

## Поля (переменные) класса

- **`defaultRoundTime`**: `number`  
  Начальная продолжительность раунда (в секундах).
- **`roundTime`**: `number`  
  Оставшееся время для текущего раунда (в секундах).
- **`intervalId`**: `ReturnType<typeof setInterval> | null`  
  Идентификатор интервала для отсчета времени. Используется для остановки таймера.
- **`mode`**: `GameModes`  
  Режим игры, определяющий продолжительность раунда (для игрока или бота).
- **`round`**: `Round`  
  Ссылка на текущий объект раунда, для которого отсчитывается время.

---

## Методы класса

### `start()`

Запускает таймер, начиная отсчет времени. Каждую секунду эмитирует событие `timer-tick` с оставшимся временем и проверяет, истекло ли время для текущего раунда. Если время заканчивается, переключает ход или завершает раунд.

### `reset()`

Сбрасывает оставшееся время до значения по умолчанию.

### `stopTimer()`

Останавливает таймер, очищая интервал и эмитируя событие `timer-reset`.

### `getTimeLeft()`

Возвращает оставшееся время для текущего раунда.

### 7. Game

Класс `Game` управляет основной логикой игры, включая создание игровых объектов, управление раундами, а также обработку пользовательского ввода. Он интегрирует все ключевые компоненты игры, такие как игровое поле, раунды, таймер и взаимодействие с пользователем. Класс также обрабатывает события начала и окончания игры.

---

## Поля (переменные) класса

- **`canvas`**: `HTMLCanvasElement`  
  Элемент HTML-канваса, на котором отображается игровое поле.
- **`gameBoard`**: `GameBoard`  
  Объект игрового поля, содержащий логику расположения и взаимодействия с карточками.
- **`currentRound`**: `Round`  
  Текущий раунд игры, управляющий состоянием раунда, переключением ходов и проверками на совпадения.

---

## Методы класса

### `addEventListeners()`

Добавляет обработчики событий для пользовательского ввода, таких как клики и касания для взаимодействия с игровым полем.

### `removeEventListeners()`

Удаляет обработчики событий для очистки ввода.

### `start()`

Запускает игру, добавляет обработчики событий и начинает текущий раунд.

### `end()`

Останавливает игру и завершает текущий раунд.

## Логика работы игры

1. При старте игры инициализируются игровое поле и карты.
2. В режиме бота игрок и бот поочередно выбирают карты.
3. В режиме игры с собой игрок поочередно выбирает карты.
4. Каждое выбранное сочетание карт проверяется на совпадение.
5. Игра продолжается, пока все карты не будут открыты.
6. В режиме бота победитель определяется по количеству найденных пар карт либо игра заканчивается.
7. В режиме игры с собой игра заканчивается либо если истечет время, либо по собственному желанию.
